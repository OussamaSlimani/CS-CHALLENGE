<form class="login-register-form-area login mr-15">
  <h2>Login</h2>
  <div class="form-group">
    <label for="loginEmail">Email</label>
    <input
      type="email"
      id="loginEmail"
      class="form-control"
      placeholder="Username or email"
    />
  </div>
  <div class="form-group">
    <label for="loginPassword">Password</label>
    <input
      type="password"
      id="loginPassword"
      class="form-control"
      placeholder="Password"
    />
  </div>
  <div class="d-flex align-items-center">
    <button type="button" class="default-btn">Log In</button>
  </div>
  <!-- Notification div -->
  <div id="notification" class="notification"></div>
</form>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    RecaptchaVerifier,
    PhoneAuthProvider,
    multiFactor,
    PhoneMultiFactorGenerator,
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC7inSQMpCJW7OJL6DdGSl386z56mupYAc",
    authDomain: "cs-challenge-f4c13.firebaseapp.com",
    databaseURL: "https://cs-challenge-f4c13-default-rtdb.firebaseio.com",
    projectId: "cs-challenge-f4c13",
    storageBucket: "cs-challenge-f4c13.firebasestorage.app",
    messagingSenderId: "657138044922",
    appId: "1:657138044922:web:1f6d141e5a5f9f7e1b5e43",
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Login function
  function loginUser(email, password) {
    if (!email || !password) {
      displayNotification("Email and password are required!", "error");
      return;
    }

    const usersRef = ref(db, "userData");

    get(usersRef)
      .then((snapshot) => {
        let userFound = false;
        snapshot.forEach((childSnapshot) => {
          const userData = childSnapshot.val();
          if (userData.email === email && userData.password === password) {
            userFound = true;
            const userId = childSnapshot.key;
            // Set the user ID in cookies
            setCookie("userId", userId, 2);
            displayNotification("Login successful!", "success");
            return;
          }
        });

        if (!userFound) {
          displayNotification("Invalid email or password.", "error");
        }
      })
      .catch((error) => {
        displayNotification("Login failed: " + error.message, "error");
      });
  }

  // reCAPTCHA Verifier
  const recaptchaVerifier = new RecaptchaVerifier(
    "recaptcha-container",
    {
      size: "invisible",
      callback: function (response) {
        // reCAPTCHA solved, you can proceed with phoneAuthProvider.verifyPhoneNumber.
        onSolvedRecaptcha();
      },
    },
    auth
  );

  function onSolvedRecaptcha() {
    // reCAPTCHA solved, you can proceed to add MFA.
    enrollSecondFactor();
  }

  // Enroll second factor (SMS)
  function enrollSecondFactor() {
    const user = auth.currentUser;
    multiFactor(user)
      .getSession()
      .then(function (multiFactorSession) {
        const phoneAuthProvider = new PhoneAuthProvider(auth);
        const phoneInfoOptions = {
          phoneNumber: "+1xxxxxxxxxx", // The phone number to enroll
          session: multiFactorSession,
        };

        // Send verification SMS
        phoneAuthProvider
          .verifyPhoneNumber(phoneInfoOptions, recaptchaVerifier)
          .then(function (verificationId) {
            // Ask user for the verification code
            const verificationCode = prompt(
              "Enter the verification code sent to your phone:"
            );
            const credential = PhoneAuthProvider.credential(
              verificationId,
              verificationCode
            );
            const multiFactorAssertion =
              PhoneMultiFactorGenerator.assertion(credential);

            multiFactor(user)
              .enroll(multiFactorAssertion, "My personal phone number")
              .then(function () {
                displayNotification(
                  "Second factor enrolled successfully!",
                  "success"
                );
              })
              .catch(function (error) {
                displayNotification(
                  "Enrollment failed: " + error.message,
                  "error"
                );
              });
          })
          .catch(function (error) {
            displayNotification(
              "SMS verification failed: " + error.message,
              "error"
            );
          });
      });
  }

  // Helper function to set a cookie
  function setCookie(name, value, days) {
    const expires = new Date(
      Date.now() + days * 24 * 60 * 60 * 1000
    ).toUTCString();
    document.cookie = `${name}=${value}; expires=${expires}; path=/`;
  }

  // Display notification message
  function displayNotification(message, type) {
    const notification = document.getElementById("notification");
    notification.innerHTML = message;
    notification.classList.add(type); // Add success/error class
  }

  // Bind login function to the button
  document
    .querySelector(".login .default-btn")
    .addEventListener("click", () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      loginUser(email, password);
    });
</script>
